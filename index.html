<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Vehicle Learning Master</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3em;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        /* TOPIC SELECTION SCREEN */
        .topic-selection {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        .topic-selection.hidden {
            display: none;
        }

        .topic-selection h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2em;
            text-align: center;
        }

        .topics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .topic-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            color: white;
            border: 3px solid transparent;
        }

        .topic-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border-color: white;
        }

        .topic-card.active {
            border-color: white;
            box-shadow: 0 10px 30px rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .topic-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
        }

        .topic-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .topic-description {
            font-size: 0.95em;
            opacity: 0.9;
        }

        /* LEVEL & MODE SELECTION */
        .mode-selection {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 900px;
            margin: 0 auto;
        }

        .mode-selection.hidden {
            display: none;
        }

        .mode-selection h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .level-selection {
            margin: 30px 0;
        }

        .level-selection h3 {
            color: #764ba2;
            margin-bottom: 15px;
        }

        .level-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .level-btn {
            padding: 15px 30px;
            font-size: 1em;
            border: 3px solid #667eea;
            border-radius: 10px;
            cursor: pointer;
            background: white;
            color: #667eea;
            font-weight: bold;
            transition: all 0.3s;
        }

        .level-btn.selected {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .level-btn:hover {
            border-color: #764ba2;
        }

        .difficulty-selection {
            margin: 30px 0;
        }

        .difficulty-selection h3 {
            color: #764ba2;
            margin-bottom: 15px;
        }

        .difficulty-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }

        .diff-btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: 3px solid #667eea;
            border-radius: 10px;
            cursor: pointer;
            background: white;
            color: #667eea;
            font-weight: bold;
            transition: all 0.3s;
        }

        .diff-btn.selected {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .mode-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 20px 40px;
            font-size: 1.3em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .mode-btn.two-player {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .mode-btn.group-mode {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .mode-btn.one-player {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        .mode-btn.match-mode {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            color: white;
        }

        .mode-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .game-board {
            display: none;
        }

        .game-board.active {
            display: block;
        }

        .scoreboard {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .player-info {
            text-align: center;
            padding: 10px 20px;
            border-radius: 10px;
            transition: all 0.3s;
        }

        .player-info.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: scale(1.1);
        }

        .player-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .player-score {
            font-size: 2em;
            font-weight: bold;
        }

        .game-info {
            text-align: center;
            color: white;
            font-size: 1.3em;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .topic-info {
            text-align: center;
            color: white;
            font-size: 1.1em;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            padding: 10px;
        }

        .card {
            aspect-ratio: 3/4;
            position: relative;
            cursor: pointer;
            perspective: 1000px;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card.matched {
            opacity: 0.5;
            pointer-events: none;
        }

        .card.matched .card-inner {
            animation: matchPulse 0.5s ease-in-out;
        }

        @keyframes matchPulse {
            0%, 100% { transform: scale(1) rotateY(180deg); }
            50% { transform: scale(1.1) rotateY(180deg); }
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        .card-back {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 2.5em;
        }

        .card-front {
            background: white;
            transform: rotateY(180deg);
            text-align: center;
            overflow: hidden;
        }

        /* Stroke Cards */
        .card-front.stroke-intake {
            background: linear-gradient(135deg, #FFE6E6 0%, #FFCCCC 100%);
            border: 4px solid #CC0000;
        }

        .card-front.stroke-compression {
            background: linear-gradient(135deg, #FFF4E6 0%, #FFE6CC 100%);
            border: 4px solid #FF8800;
        }

        .card-front.stroke-power {
            background: linear-gradient(135deg, #E6F7E6 0%, #CCF0CC 100%);
            border: 4px solid #008800;
        }

        .card-front.stroke-exhaust {
            background: linear-gradient(135deg, #E6F0FF 0%, #CCE0FF 100%);
            border: 4px solid #0044CC;
        }

        /* Component Cards */
        .card-front.component {
            background: linear-gradient(135deg, #FFF9E6 0%, #FFEDCC 100%);
            border: 4px solid #FF6600;
        }

        /* Valve Cards */
        .card-front.valve {
            background: linear-gradient(135deg, #F0E6FF 0%, #E0CCFF 100%);
            border: 4px solid #9933FF;
        }

        .card-emoji {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 1.1em;
            margin-bottom: 0;
            line-height: 1.2;
            font-weight: bold;
        }

        .card-type {
            font-size: 0.7em;
            opacity: 0.6;
            margin-bottom: 0;
            text-transform: uppercase;
            font-weight: bold;
            display: none;
        }

        .card-content {
            font-size: 0.85em;
            line-height: 1.4;
            font-weight: 500;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-restart {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-menu {
            background: white;
            color: #667eea;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .victory-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .victory-modal.active {
            display: flex;
        }

        .victory-content {
            background: white;
            padding: 50px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            animation: victorySlideIn 0.5s ease-out;
        }

        @keyframes victorySlideIn {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .victory-content h2 {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .victory-content p {
            font-size: 1.5em;
            margin-bottom: 30px;
        }

        .confetti {
            font-size: 3em;
            margin-bottom: 20px;
            animation: confettiSpin 2s infinite;
        }

        @keyframes confettiSpin {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(360deg); }
        }

        .no-topics-message {
            text-align: center;
            color: white;
            font-size: 1.5em;
            padding: 40px;
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8em;
                margin-bottom: 5px;
            }

            .header p {
                font-size: 1em;
            }

            .topics-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }

            .topic-card {
                padding: 20px;
            }

            .topic-icon {
                font-size: 2.5em;
            }

            .topic-name {
                font-size: 1.1em;
            }

            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                padding: 5px;
            }

            .scoreboard {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }

            .player-info {
                padding: 8px 15px;
            }

            .player-name {
                font-size: 1em;
            }

            .player-score {
                font-size: 1.5em;
            }

            .card-emoji {
                font-size: 2em;
            }

            .card-title {
                font-size: 1em;
            }

            .card-content {
                font-size: 0.75em;
            }

            .game-info {
                font-size: 1em;
                padding: 10px;
                margin-bottom: 15px;
            }

            .action-buttons {
                gap: 10px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 0.95em;
            }
        }

        @media (max-width: 480px) {
            .topics-grid {
                grid-template-columns: 1fr;
            }

            .cards-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
            }

            .card-emoji {
                font-size: 1.8em;
            }

            .btn {
                padding: 10px 15px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>üèéÔ∏è Motor Vehicle Learning Master üèéÔ∏è</h1>
            <p>Master automotive technology through interactive matching games!</p>
        </div>

        <!-- Topic Selection Screen -->
        <div class="topic-selection" id="topicSelection">
            <h2>üìö Select a Topic</h2>
            <div class="topics-grid" id="topicsGrid"></div>
        </div>

        <!-- Mode Selection Screen -->
        <div class="mode-selection" id="modeSelection" class="hidden">
            <h2>Choose Your Challenge</h2>
            
            <div class="level-selection">
                <h3>Select Level</h3>
                <div class="level-buttons" id="levelButtons"></div>
            </div>

            <div class="difficulty-selection">
                <h3>Select Difficulty</h3>
                <div class="difficulty-buttons" id="difficultyButtons"></div>
            </div>

            <div class="mode-buttons">
                <button class="mode-btn one-player" onclick="startGame('one-player')">
                    üéÆ Solo Challenge
                </button>
                <button class="mode-btn two-player" onclick="startGame('two-player')">
                    üë• 2 Player Battle
                </button>
                <button class="mode-btn group-mode" onclick="startGame('group')">
                    üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Group Pairs
                </button>
                <button class="mode-btn match-mode" onclick="startGame('match-mode')">
                    üéØ Match Challenge
                </button>
            </div>
        </div>

        <!-- Game Board -->
        <div class="game-board" id="gameBoard">
            <div class="topic-info" id="topicInfo"></div>
            
            <div class="scoreboard" id="scoreboard">
                <div class="player-info active" id="player1Info">
                    <div class="player-name">Player 1</div>
                    <div class="player-score" id="player1Score">0</div>
                </div>
                <div class="player-info" id="player2Info">
                    <div class="player-name">Player 2</div>
                    <div class="player-score" id="player2Score">0</div>
                </div>
            </div>

            <!-- Match Mode Specific Display -->
            <div id="matchModeDisplay" style="display:none; background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.2);">
                <h3 style="text-align: center; color: #667eea; margin-bottom: 15px;">Match the Cards</h3>
                <div id="matchModeContent" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;"></div>
            </div>

            <div class="game-info" id="gameInfo">
                Player 1's Turn - Find matching pairs!
            </div>

            <div class="cards-grid" id="cardsGrid"></div>

            <div class="action-buttons">
                <button class="btn btn-restart" onclick="restartGame()">üîÑ Restart</button>
                <button class="btn btn-menu" onclick="backToMenu()">üè† Menu</button>
            </div>
        </div>

        <!-- Victory Modal -->
        <div class="victory-modal" id="victoryModal">
            <div class="victory-content">
                <div class="confetti">üéâüéäüéâ</div>
                <h2 id="victoryTitle">Game Over!</h2>
                <p id="victoryMessage"></p>
                <div class="action-buttons">
                    <button class="btn btn-restart" onclick="restartGame()">Play Again</button>
                    <button class="btn btn-menu" onclick="backToMenu()">Main Menu</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            topics: [],
            selectedTopic: null,
            selectedTopicName: null,
            selectedLevel: null,
            selectedLevelName: null,
            gameMode: '',
            currentPlayer: 1,
            scores: { player1: 0, player2: 0 },
            flippedCards: [],
            matchedPairs: 0,
            gameCards: [],
            totalPairs: 0,
            difficulty: 'easy',
            imageBank: null
        };

        // Load Image Bank
        async function loadImageBank() {
            try {
                const response = await fetch('cards/images-bank.json');
                const data = await response.json();
                gameState.imageBank = data.images;
                console.log('Image bank loaded:', Object.keys(data.images).length, 'categories');
                return true;
            } catch (error) {
                console.warn('Image bank not available:', error.message);
                return false;
            }
        }

        // Resolve image_id to actual URL from image bank
        function resolveImageUrl(imageId) {
            if (!gameState.imageBank || !imageId) return null;
            
            // Search through all categories
            for (const category in gameState.imageBank) {
                if (gameState.imageBank[category][imageId]) {
                    return gameState.imageBank[category][imageId].url;
                }
            }
            return null;
        }

        // Initialize app
        async function init() {
            try {
                // Load image bank first
                await loadImageBank();
                
                const response = await fetch('topics.json');
                const data = await response.json();
                gameState.topics = data.topics;
                renderTopics();
            } catch (error) {
                console.error('Error loading topics:', error);
                document.getElementById('topicSelection').innerHTML = '<div class="no-topics-message">Error loading topics. Please refresh the page.</div>';
            }
        }

        function renderTopics() {
            const grid = document.getElementById('topicsGrid');
            grid.innerHTML = '';

            gameState.topics.forEach(topic => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.innerHTML = `
                    <div class="topic-icon">${topic.icon}</div>
                    <div class="topic-name">${topic.name}</div>
                    <div class="topic-description">${topic.description}</div>
                `;
                card.onclick = () => selectTopic(topic);
                grid.appendChild(card);
            });
        }

        function selectTopic(topic) {
            gameState.selectedTopic = topic.id;
            gameState.selectedTopicName = topic.name;
            gameState.selectedLevel = topic.levels[0];

            document.getElementById('topicSelection').classList.add('hidden');
            document.getElementById('modeSelection').classList.remove('hidden');
            renderLevelButtons();
            renderDifficultyButtons();
        }

        function renderLevelButtons() {
            const container = document.getElementById('levelButtons');
            container.innerHTML = '';

            const topic = gameState.topics.find(t => t.id === gameState.selectedTopic);
            topic.levels.forEach(level => {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                
                const levelNames = {
                    'entry': 'Entry (Basics)',
                    'level1': 'Level 1 (Foundation)',
                    'level2': 'Level 2 (Intermediate)',
                    'level3': 'Level 3 (Advanced)'
                };
                
                btn.textContent = levelNames[level] || level;
                if (level === gameState.selectedLevel) btn.classList.add('selected');
                btn.onclick = () => selectLevel(level, levelNames[level] || level);
                container.appendChild(btn);
            });
        }

        function selectLevel(level, name) {
            gameState.selectedLevel = level;
            gameState.selectedLevelName = name;
            document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function renderDifficultyButtons() {
            const container = document.getElementById('difficultyButtons');
            container.innerHTML = `
                <button class="diff-btn selected" onclick="selectDifficulty('easy')">
                    üòä Easy (Fewer cards)
                </button>
                <button class="diff-btn" onclick="selectDifficulty('medium')">
                    ü§î Medium (More cards)
                </button>
                <button class="diff-btn" onclick="selectDifficulty('hard')">
                    üî• Hard (All cards)
                </button>
            `;
        }

        function selectDifficulty(difficulty) {
            document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.diff-btn').classList.add('selected');
            gameState.difficulty = difficulty;
        }

        function startGame(mode) {
            gameState.gameMode = mode;
            gameState.currentPlayer = 1;
            gameState.scores = { player1: 0, player2: 0 };
            gameState.flippedCards = [];
            gameState.matchedPairs = 0;

            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('gameBoard').classList.add('active');

            // Show/hide scoreboard based on mode
            const scoreboard = document.getElementById('scoreboard');
            const player2Info = document.getElementById('player2Info');
            const matchModeDisplay = document.getElementById('matchModeDisplay');
            const cardsGrid = document.getElementById('cardsGrid');

            if (mode === 'one-player') {
                scoreboard.style.display = 'flex';
                player2Info.style.display = 'none';
                matchModeDisplay.style.display = 'none';
                cardsGrid.style.display = 'grid';
                document.getElementById('player1Info').querySelector('.player-name').textContent = 'Solo Player';
            } else if (mode === 'group') {
                scoreboard.style.display = 'flex';
                player2Info.style.display = 'block';
                matchModeDisplay.style.display = 'none';
                cardsGrid.style.display = 'grid';
                document.getElementById('player1Info').querySelector('.player-name').textContent = 'Team 1';
                document.getElementById('player2Info').querySelector('.player-name').textContent = 'Team 2';
            } else if (mode === 'match-mode') {
                scoreboard.style.display = 'flex';
                player2Info.style.display = 'none';
                matchModeDisplay.style.display = 'block';
                cardsGrid.style.display = 'none';
                document.getElementById('player1Info').querySelector('.player-name').textContent = 'Score';
            } else {
                // two-player
                scoreboard.style.display = 'flex';
                player2Info.style.display = 'block';
                matchModeDisplay.style.display = 'none';
                cardsGrid.style.display = 'grid';
                document.getElementById('player1Info').querySelector('.player-name').textContent = 'Player 1';
                document.getElementById('player2Info').querySelector('.player-name').textContent = 'Player 2';
            }

            loadGameCards();

        }

        async function loadGameCards() {
            try {
                const response = await fetch(`cards/${gameState.selectedTopic}.json`);
                const cardData = await response.json();
                const levelData = cardData.levels[gameState.selectedLevel];

                if (!levelData) {
                    alert('Level data not found');
                    return;
                }

                let allCards = [...levelData.cards];
                
                // Filter cards based on difficulty
                if (gameState.difficulty === 'easy') {
                    allCards = allCards.slice(0, levelData.pairCount === 4 ? 8 : Math.min(8, allCards.length));
                } else if (gameState.difficulty === 'medium') {
                    allCards = allCards.slice(0, Math.min(12, allCards.length));
                }
                // hard = all cards

                gameState.gameCards = shuffleArray(allCards);
                gameState.totalPairs = gameState.gameCards.length / 2;

                updateTopicInfo(levelData.name);
                updateScoreboard();
                
                if (gameState.gameMode === 'match-mode') {
                    renderMatchMode();
                } else {
                    renderCards();
                }
            } catch (error) {
                console.error('Error loading game cards:', error);
                alert('Error loading game cards');
                backToMenu();
            }
        }

        function updateTopicInfo(levelName) {
            document.getElementById('topicInfo').textContent = `${gameState.selectedTopicName} - ${levelName}`;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function renderMatchMode() {
            const container = document.getElementById('matchModeContent');
            container.innerHTML = '';
            
            // Get unique match IDs (one pair per matchId)
            const matchIds = [];
            const seenIds = new Set();
            
            gameState.gameCards.forEach(card => {
                if (!seenIds.has(card.matchId)) {
                    matchIds.push(card.matchId);
                    seenIds.add(card.matchId);
                }
            });

            // Shuffle which cards are shown as the source
            const sourceCardIndices = shuffleArray(gameState.gameCards.map((_, i) => i)).slice(0, matchIds.length);
            gameState.matchModeState = {
                matchedPairs: 0,
                totalPairs: matchIds.length,
                sourceIndices: sourceCardIndices,
                matchIds: matchIds
            };

            sourceCardIndices.forEach((sourceIdx, pairIdx) => {
                const sourceCard = gameState.gameCards[sourceIdx];
                const matchId = sourceCard.matchId;
                
                // Find all cards with same matchId
                const matchingCards = gameState.gameCards.filter(c => c.matchId === matchId && gameState.gameCards.indexOf(c) !== sourceIdx);
                
                // Create a match challenge item
                const item = document.createElement('div');
                item.style.cssText = 'padding: 15px; border-radius: 10px; border: 2px solid #ddd; cursor: pointer; transition: all 0.3s;';
                
                // Resolve image URL: try image_id first (from bank), then fall back to image_url
                let imageUrl = null;
                if (sourceCard.image_id) {
                    imageUrl = resolveImageUrl(sourceCard.image_id);
                } else if (sourceCard.image_url) {
                    imageUrl = sourceCard.image_url;
                }
                
                item.innerHTML = `
                    <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 10px;">${sourceCard.title}</div>
                    <div style="font-size: 2em; margin-bottom: 8px;">${sourceCard.emoji}</div>
                    ${imageUrl ? `<img src="${imageUrl}" alt="${sourceCard.title}" style="max-width: 80px; margin-bottom: 8px; border-radius: 5px;">` : ''}
                    <div style="font-size: 0.9em; color: #666;">${sourceCard.content}</div>
                    <div id="matchOptions_${pairIdx}" style="margin-top: 10px; display: grid; grid-template-columns: 1fr; gap: 8px;"></div>
                `;
                
                const optionsContainer = item.querySelector(`#matchOptions_${pairIdx}`);
                
                // Add matching options (correct + wrong options)
                const correctCard = matchingCards[0];
                const wrongCards = gameState.gameCards.filter(c => c.matchId !== matchId && sourceCardIndices.indexOf(gameState.gameCards.indexOf(c)) === -1).slice(0, 2);
                
                const options = [correctCard, ...wrongCards].sort(() => Math.random() - 0.5);
                
                options.forEach((option, optIdx) => {
                    const btn = document.createElement('button');
                    const isCorrect = option.matchId === matchId;
                    btn.style.cssText = `
                        padding: 8px; 
                        border-radius: 5px; 
                        border: 1px solid #ddd; 
                        background: white; 
                        cursor: pointer; 
                        transition: all 0.2s;
                        font-size: 0.9em;
                    `;
                    btn.textContent = `${option.emoji} ${option.title}`;
                    btn.onclick = () => handleMatchModeSelection(isCorrect, btn, optionsContainer, pairIdx);
                    optionsContainer.appendChild(btn);
                });
                
                container.appendChild(item);
            });
        }

        function handleMatchModeSelection(isCorrect, buttonElement, container, pairIdx) {
            if (isCorrect) {
                gameState.scores.player1++;
                gameState.matchModeState.matchedPairs++;
                buttonElement.style.cssText += 'background: #4CAF50; color: white; border-color: #4CAF50;';
                container.querySelectorAll('button').forEach(btn => btn.disabled = true);
                updateGameInfo('‚úÖ Correct match!');
                updateScoreboard();
                
                if (gameState.matchModeState.matchedPairs === gameState.matchModeState.totalPairs) {
                    setTimeout(showVictory, 1500);
                }
            } else {
                buttonElement.style.cssText += 'background: #f44336; color: white; border-color: #f44336;';
                updateGameInfo('‚ùå Try again!');
            }
        }

        function renderCards() {
            const grid = document.getElementById('cardsGrid');
            grid.innerHTML = '';

            gameState.gameCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.dataset.index = index;
                cardElement.dataset.matchId = card.matchId;

                // Resolve image URL: try image_id first (from bank), then fall back to image_url
                let imageUrl = null;
                if (card.image_id) {
                    imageUrl = resolveImageUrl(card.image_id);
                } else if (card.image_url) {
                    imageUrl = card.image_url;
                }

                cardElement.innerHTML = `
                    <div class="card-inner">
                        <div class="card-face card-back">üèéÔ∏è</div>
                        <div class="card-face card-front">
                            <div class="card-emoji">${card.emoji}</div>
                            ${imageUrl ? `<img src="${imageUrl}" alt="${card.title}" style="max-width: 60px; max-height: 60px; margin: 5px 0; border-radius: 3px;">` : ''}
                            <div class="card-title">${card.title}</div>
                            <div class="card-type">${card.type}</div>
                            <div class="card-content">${card.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                `;

                cardElement.addEventListener('click', () => flipCard(index));
                grid.appendChild(cardElement);
            });
        }

        function flipCard(index) {
            const cardElement = document.querySelectorAll('.card')[index];

            if (cardElement.classList.contains('flipped') ||
                cardElement.classList.contains('matched') ||
                gameState.flippedCards.length >= 2) {
                return;
            }

            cardElement.classList.add('flipped');
            gameState.flippedCards.push(index);

            if (gameState.flippedCards.length === 2) {
                setTimeout(checkMatch, 1000);
            }
        }

        function checkMatch() {
            const [index1, index2] = gameState.flippedCards;
            const card1 = gameState.gameCards[index1];
            const card2 = gameState.gameCards[index2];
            const cardElements = document.querySelectorAll('.card');

            if (card1.matchId === card2.matchId) {
                // Match found!
                cardElements[index1].classList.add('matched');
                cardElements[index2].classList.add('matched');

                gameState.scores[`player${gameState.currentPlayer}`]++;
                gameState.matchedPairs++;

                updateScoreboard();

                if (gameState.matchedPairs === gameState.totalPairs) {
                    setTimeout(showVictory, 500);
                } else {
                    if (gameState.gameMode === 'one-player') {
                        updateGameInfo(`Great job! Found a match! üéâ`);
                    } else {
                        const label = gameState.gameMode === 'group' ? 'Team' : 'Player';
                        updateGameInfo(`${label} ${gameState.currentPlayer} got a match! üéâ`);
                    }
                }
            } else {
                // No match
                cardElements[index1].classList.remove('flipped');
                cardElements[index2].classList.remove('flipped');

                if (gameState.gameMode !== 'one-player') {
                    gameState.currentPlayer = gameState.currentPlayer === 1 ? 2 : 1;
                    const label = gameState.gameMode === 'group' ? 'Team' : 'Player';
                    updateGameInfo(`${label} ${gameState.currentPlayer}'s turn`);
                } else {
                    updateGameInfo(`Not a match, try again!`);
                }
            }

            updateActivePlayer();
            gameState.flippedCards = [];
        }

        function updateScoreboard() {
            document.getElementById('player1Score').textContent = gameState.scores.player1;
            document.getElementById('player2Score').textContent = gameState.scores.player2;
        }

        function updateActivePlayer() {
            const player1Info = document.getElementById('player1Info');
            const player2Info = document.getElementById('player2Info');

            if (gameState.currentPlayer === 1) {
                player1Info.classList.add('active');
                player2Info.classList.remove('active');
            } else {
                player1Info.classList.remove('active');
                player2Info.classList.add('active');
            }
        }

        function updateGameInfo(message) {
            document.getElementById('gameInfo').textContent = message;
        }

        function showVictory() {
            const modal = document.getElementById('victoryModal');
            const title = document.getElementById('victoryTitle');
            const message = document.getElementById('victoryMessage');

            if (gameState.gameMode === 'one-player') {
                title.textContent = `üèÜ Excellent! üèÜ`;
                message.textContent = `You matched all pairs!\nFinal Score: ${gameState.scores.player1}`;
            } else if (gameState.gameMode === 'match-mode') {
                title.textContent = `üèÜ Congratulations! üèÜ`;
                message.textContent = `You completed all matches!\nFinal Score: ${gameState.scores.player1}`;
            } else {
                const playerLabel = gameState.gameMode === 'group' ? 'Team' : 'Player';

                if (gameState.scores.player1 > gameState.scores.player2) {
                    title.textContent = `üèÜ ${playerLabel} 1 Wins! üèÜ`;
                    message.textContent = `Final Score: ${gameState.scores.player1} - ${gameState.scores.player2}`;
                } else if (gameState.scores.player2 > gameState.scores.player1) {
                    title.textContent = `üèÜ ${playerLabel} 2 Wins! üèÜ`;
                    message.textContent = `Final Score: ${gameState.scores.player2} - ${gameState.scores.player1}`;
                } else {
                    title.textContent = 'ü§ù It\'s a Tie! ü§ù';
                    message.textContent = `Final Score: ${gameState.scores.player1} - ${gameState.scores.player2}`;
                }
            }

            modal.classList.add('active');
        }

        function restartGame() {
            document.getElementById('victoryModal').classList.remove('active');
            loadGameCards();
        }

        function backToMenu() {
            document.getElementById('victoryModal').classList.remove('active');
            document.getElementById('gameBoard').classList.remove('active');
            document.getElementById('modeSelection').classList.add('hidden');
            document.getElementById('topicSelection').classList.remove('hidden');

            document.getElementById('player1Info').querySelector('.player-name').textContent = 'Player 1';
            document.getElementById('player2Info').querySelector('.player-name').textContent = 'Player 2';

            gameState = {
                topics: gameState.topics,
                selectedTopic: null,
                selectedTopicName: null,
                selectedLevel: null,
                selectedLevelName: null,
                gameMode: '',
                currentPlayer: 1,
                scores: { player1: 0, player2: 0 },
                flippedCards: [],
                matchedPairs: 0,
                gameCards: [],
                totalPairs: 0,
                difficulty: 'easy'
            };
        }

        // Start the app
        init();
    </script>
</body>
</html>
